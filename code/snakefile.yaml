# Snakefile

Ancestry = ['black', 'asian', 'mixed', 'chinese']
CHR = range(1, 23)

configfile: "config.yaml"

rule all:
    input:
        expand(
            "{out_dir}/{ancestry}_filtered_all_chr{chr}.snplist",
            out_dir=config["paths"]["snp_list_dir"],
            ancestry=Ancestry,
            chr=CHR
        )

# Step 1: Filter SNP List per Ancestry
rule filter_snplist_per_ancestry:
    input:
        geno_dir = config["paths"]["geno_dir"],
        sample_ids = config["paths"]["sample_ids_dir"] + "/{ancestry}_ids.txt"
    output:
        "{out_dir}/{ancestry}_filtered_all_chr{chr}.snplist"
    params:
        plink_executable = config["paths"]["plink_executable"]
    resources:
        cpus = config["resources"]["filter_snplist"]["cpus"],
        mem_mb = int(config["resources"]["filter_snplist"]["mem_mb"].replace("G", "")) * 1024,
        time = config["resources"]["filter_snplist"]["time"],
        partition = config["resources"]["filter_snplist"]["partition"],
        nodelist = config["resources"]["filter_snplist"]["nodelist"]
    shell:
        """
        {params.plink_executable} \
        --bfile {input.geno_dir}/ukb22418_c{wildcards.chr}_b0_v2_s488243 \
        --keep {input.sample_ids} \
        --maf 0.01 \
        --mac 5 \
        --geno 0.1 \
        --hwe 1e-10 \
        --keep-allele-order \
        --threads {resources.cpus} \
        --write-snplist \
        --out {output}
        """

# Step 2: Merge Filtered Genotypes for Each Ancestry

rule merge_filtered_genotypes_per_ancestry:
    input:
        expand("{out_dir}/{ancestry}_filtered_all_chr{chr}.snplist", out_dir=config["paths"]["snp_list_dir"], ancestry="{ancestry}", chr=range(1, 23)),
        sample_ids=config["paths"]["sample_ids_dir"] + "/{ancestry}_sample_ids.txt"
    output:
        merged_geno="{out_dir}/{ancestry}_combined_genotypes_filtered_sampled_20240402.bed"
    params:
        plink_executable=config["paths"]["plink_executable"],
        geno_dir=config["paths"]["geno_dir"],
        snp_list_dir=config["paths"]["snp_list_dir"],
        out_dir=config["paths"]["out_dir"]
    resources:
        cpus=config["resources"]["merge_genotypes"]["cpus"],
        mem_mb=int(config["resources"]["merge_genotypes"]["mem_mb"].replace("G", "")) * 1024,
        time=config["resources"]["merge_genotypes"]["time"],
        partition=config["resources"]["merge_genotypes"]["partition"],
        nodelist=config["resources"]["merge_genotypes"]["nodelist"]
    shell:
        """
        MERGE_LIST={params.out_dir}/{ancestry}_merge_list_all_20240402.txt
        > ${{MERGE_LIST}}  # Clear the merge list file content
        
        for CHR in {{1..22}}; do
            {params.plink_executable} --bfile {params.geno_dir}/ukb22418_c${{CHR}}_b0_v2_s488243 \
                                      --keep {input.sample_ids} \
                                      --extract {params.snp_list_dir}/{ancestry}_filtered_all_chr${{CHR}}.snplist \
                                      --make-bed \
                                      --keep-allele-order \
                                      --threads {resources.cpus} \
                                      --out {params.out_dir}/{ancestry}_chr${{CHR}}_filtered_all_20240402
            if [ "${{CHR}}" -gt 1 ]; then
                echo "{params.out_dir}/{ancestry}_chr${{CHR}}_filtered_all_20240402.bed {params.out_dir}/{ancestry}_chr${{CHR}}_filtered_all_20240402.bim {params.out_dir}/{ancestry}_chr${{CHR}}_filtered_all_20240402.fam" >> ${{MERGE_LIST}}
            fi
        done
        
        {params.plink_executable} --bfile {params.out_dir}/{ancestry}_chr1_filtered_all_20240402 \
                                  --merge-list ${{MERGE_LIST}} \
                                  --make-bed \
                                  --keep-allele-order \
                                  --threads {resources.cpus} \
                                  --out {output.merged_geno}
        """

# Step 3: Prune and Create GRM for Each Ancestry
rule grm_sampled_pruned_per_ancestry:
    input:
        merged_geno="{out_dir}/{ancestry}_combined_genotypes_filtered_sampled_20240402.bed",
        sample_ids=config["paths"]["sample_ids_dir"] + "/{ancestry}_sample_ids.txt"
    output:
        grm="{out_dir}/{ancestry}_grm_sampled_pruned_20240402.bed"
    params:
        plink_executable=config["paths"]["plink_executable"],
        out_dir=config["paths"]["out_dir"]
    resources:
        cpus=config["resources"]["grm_prune"]["cpus"],
        mem_mb=int(config["resources"]["grm_prune"]["mem_mb"].replace("G", "")) * 1024,
        time=config["resources"]["grm_prune"]["time"],
        partition=config["resources"]["grm_prune"]["partition"],
        nodelist=config["resources"]["grm_prune"]["nodelist"]
    shell:
        """
        {params.plink_executable} --bfile {input.merged_geno} \
                                  --keep {input.sample_ids} \
                                  --keep-allele-order \
                                  --rel-cutoff 0.05 \
                                  --threads {resources.cpus} \
                                  --out {output.grm}
        """

