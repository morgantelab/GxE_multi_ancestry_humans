# Snakefile

configfile: "config.yaml"

rule all:
    input:
        expand(config["gwas_dir"] + "/" + "gxe_{env}_{foldnum}_S_A.done", env=config["ENV"], foldnum=config["FOLDNUM"])

#### Start of rules ####

## Creating GRMs ##

# Step 1: Filter SNP List per Ancestry

rule filter_snplist_per_ancestry:
    input:
        bfile=config["geno_dir"] + "/" + "ukb22418_c{chr}_b0_v2_s488243" + config["EXT"],
        sample_ids=config["sample_ids_dir"] + "/" + "{ancestry}_ids.txt"
    output:
        SNPLIST=config["snp_list_dir"] + "/" + "{ancestry}_filtered_all_chr{chr}.snplist"
    params:
        plink_executable = config["plink_executable"],
        THREADS=4,
        MAF=config["MAF"],
        GENO=config["GENO"],
        HWE=config["HWE"],
        MAC=config["MAC"],
        IPREFIX=config["geno_dir"]+ "/" + "ukb22418_c{chr}_b0_v2_s488243",
        OPREFIX="{ancestry}_filtered_all_chr{chr}",
        SNPDIR=config["snp_list_dir"]
    resources:
        cpus=4, mem_mb=20000, time_min=1440
    shell:
        """
        cd {params.SNPDIR}

        {params.plink_executable} \
        --bfile {params.IPREFIX} \
        --keep {input.sample_ids} \
        --maf {params.MAF} \
        --mac {params.MAC} \
        --geno {params.GENO} \
        --hwe {params.HWE} \
        --keep-allele-order \
        --threads {params.THREADS} \
        --write-snplist \
        --out {params.OPREFIX}
        """

# Step 1.5 Create Common SNP list across Ancestries

rule common_snps:
    input:
        expand(config["snp_list_dir"] + "/" + "{ancestry}_filtered_all_chr{chr}.snplist",ancestry=config["Ancestry"], chr=config["CHR"])
    output:
        config["snp_list_dir"] + "/" + "common_snps_all_ancestries.txt"
    params:
        INPUTDIR=config["snp_list_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "common_snps.R"
    resources: cpus=1, mem_mb=20000, time_min=1440
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -o {output}
        """

# Step 2: Filtered CHR for Common snps

rule filtered_chr_common_snps:
    input:
        bfile=config["geno_dir"] + "/" + "ukb22418_c{chr}_b0_v2_s488243" + config["EXT"],
        common_snps=config["snp_list_dir"] + "/" + "common_snps_all_ancestries.txt"
    output:
        CHR_filtered=config["filtered_chr_dir"] + "/" + "filtered_chr{chr}.bed"
    params:
        plink_executable = config["plink_executable"],
        GENO=config["GENO"],
        THREADS=4,
        IPREFIX=config["geno_dir"]+ "/" + "ukb22418_c{chr}_b0_v2_s488243",
        OPREFIX="filtered_chr{chr}",
        CHRDIR=config["filtered_chr_dir"]
    resources:
        cpus=4, mem_mb=20000, time_min=1440
    shell:
        """
        cd {params.CHRDIR}

        {params.plink_executable} \
        --bfile {params.IPREFIX} \
        --extract {input.common_snps} \
        --make-bed \
        --keep-allele-order \
        --threads {params.THREADS} \
        --out {params.OPREFIX}
        """

# Step 2.5: create merge_list

rule create_merge_list:
    input:
        expand(config["filtered_chr_dir"] + "/" + "filtered_chr{chr}.bed", chr=config["CHR"])
    output:
        merge_list=config["filtered_chr_dir"] + "/" + "merge_list.txt"
    resources:
        cpus=1, mem_mb=10000, time_min=1440
    shell:
        """
        ls {input} | xargs -n 1 basename | sed 's/.bed$//' > {output}
        """

# Step 2.5: Merged CHR for common snps

rule merge_chr_common_snps:
    input:
        merge_list=config["filtered_chr_dir"] + "/" + "merge_list.txt"
    output:
        merged_geno=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps.bed"
    params:
        plink_executable = config["plink_executable"],
        THREADS=4,
        OPREFIX="merged_geno_common_snps",
        CHRDIR=config["filtered_chr_dir"]
    resources:
        cpus=4, mem_mb=80000, time_min=1440
    shell:
        """
        cd {params.CHRDIR}

        {params.plink_executable} \
        --merge-list {input.merge_list} \
        --make-bed \
        --keep-allele-order \
        --threads {params.THREADS} \
        --out {params.OPREFIX}
        """

# Step 3: Pruned GRM for each ancestry

rule pruned_grm_ancestry:
    input:
        bfile=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps.bed",
        sample_ids=config["sample_ids_dir"] + "/" + "{ancestry}_ids.txt"
    output:
        GRM_pruned=config["filtered_chr_dir"] + "/" + "pruned_grm_{ancestry}.rel.id"
    params:
        plink_executable = config["plink_executable"],
        THREADS=10,
        IPREFIX=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps",
        OPREFIX="pruned_grm_{ancestry}",
        CHRDIR=config["filtered_chr_dir"]
    resources:
        cpus=10, mem_mb=900000, time_min=3000
    shell:
        """
        cd {params.CHRDIR}

        {params.plink_executable} \
        --bfile {params.IPREFIX} \
        --keep {input.sample_ids} \
        --keep-allele-order \
        --threads {params.THREADS} \
        --rel-cutoff 0.05 \
        --out {params.OPREFIX}
        """

##NEED TO ADD script for sampling white and creating merged id list.

# Step 4: GRM using plink

rule grm_by_plink:
    input:
        bfile=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps.bed",
        all_ids=config["filtered_chr_dir"] + "/" + "merged_ids.rel.id"
    output:
        GRM_plink=config["filtered_chr_dir"] + "/" + "grm_by_plink.grm.bin"
    params:
        plink_executable = config["plink_executable"],
        THREADS=10,
        IPREFIX=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps",
        OPREFIX="grm_by_plink",
        CHRDIR=config["filtered_chr_dir"]
    resources:
        cpus=10, mem_mb=900000, time_min=3000
    shell:
        """
        cd {params.CHRDIR}

        {params.plink_executable} \
        --bfile {params.IPREFIX} \
        --keep {input.all_ids} \
        --keep-allele-order \
        --threads {params.THREADS} \
        --make-grm-bin \
        --out {params.OPREFIX}
        """

# Step 5: create grm using fabio struct method

rule grm_by_struct_mtd:
    input:
        bfile=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps.bed",
        dataset=config["sample_ids_dir"] + "/" + "data2_20240930.RData",
	      ids=config["filtered_chr_dir"] + "/" + "merged_ids.rel.id"
    output:
        eigen_struct=config["filtered_chr_dir"] + "/" + "eigen_by_struct.rds"
    params:
        INPUTDIR=config["filtered_chr_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "eigen_by_struct.R"
    resources: cpus=55, mem_mb=1400000, time_min=5000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=55
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -b {input.bfile} -s {input.dataset} -i {input.ids} -o {output}
        """

# Step 6: Make bed geno of selected indv

rule merged_geno_common_snps_selected_indv:
    input:
        bfile=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps.bed",
        all_ids=config["filtered_chr_dir"] + "/" + "merged_ids.rel.id"
    output:
        merged_geno_common_snps_selected_indv=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv.bed"
    params:
        plink_executable = config["plink_executable"],
        THREADS=10,
        IPREFIX=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps",
        OPREFIX="merged_geno_common_snps_selected_indiv",
        CHRDIR=config["filtered_chr_dir"]
    resources:
        cpus=10, mem_mb=900000, time_min=3000
    shell:
        """
        cd {params.CHRDIR}

        {params.plink_executable} \
        --bfile {params.IPREFIX} \
        --keep {input.all_ids} \
        --keep-allele-order \
        --threads {params.THREADS} \
        --make-bed \
        --out {params.OPREFIX}
        """

# Step 7: convert plink to gds for pcrelate grm

rule plink_to_gds:
    input:
        bed=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv.bed",
        bim=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv.bim",
        fam=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv.fam"
    output:
        gds=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv.gds"
    params:
        INPUTDIR=config["filtered_chr_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "convert_plink_to_gds.R"
    resources: cpus=1, mem_mb=900000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1

        Rscript {params.SCRIPT} -d {params.INPUTDIR} -b {input.bed} -i {input.bim} -f {input.fam} -o {output}
        """

# Step 8: pcrelate grm

rule grm_by_pcrelate:
    input:
        gds=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv.gds"
    output:
        kinship_matrix=config["filtered_chr_dir"] + "/" + "king_kinship_matrix_for_pcrelate.RData",
        pcair_results=config["filtered_chr_dir"] + "/" + "pcair_for_pcrelate_results.rds",
        pcrelate_results=config["filtered_chr_dir"] + "/" + "pcrelate_calcs.rds",
        grm_matrix=config["filtered_chr_dir"] + "/" + "grm_matrix_pcrelate_5pcs.RData"
    params:
        INPUTDIR=config["filtered_chr_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "grm_by_pcrelate.R",
        cores=55
    resources: cpus=55, mem_mb=1000000, time_min=5000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1

        Rscript {params.SCRIPT} -d {params.INPUTDIR} -g {input.gds} -k {output.kinship_matrix} -p {output.pcair_results} -r {output.pcrelate_results} -m {output.grm_matrix} -c {params.cores}
        """


# Step 9: pca of grm by plink using eigen in R instead of gcta pca

rule pca_for_grm_by_plink:
    input:
        grm=config["filtered_chr_dir"] + "/" + "grm_by_plink.grm.bin"
    output:
        pca_results=config["filtered_chr_dir"] + "/" + "pca_for_plink.rds"
    params:
        INPUTDIR=config["filtered_chr_dir"],
	IPREFIX=config["filtered_chr_dir"] + "/" + "grm_by_plink",
        SCRIPT=config["SCRIPT"] + "/" + "pca_for_grm_by_plink_using_eigen_in_R.R"
    resources: cpus=1, mem_mb=60000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -i {params.IPREFIX} -o {output.pca_results}
        """

# Step 10: pca of pcrelate grm

rule pca_for_grm_by_pcrelate:
    input:
        grm=config["filtered_chr_dir"] + "/" + "grm_matrix_pcrelate_5pcs.RData"
    output:
        pca_results=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds"
    params:
        INPUTDIR=config["filtered_chr_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pca_for_grm_by_pcrelate.R"
    resources: cpus=1, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -i {input.grm} -o {output.pca_results}
        """

##need scaled dataset script
###Need scaled pcs script

# Step 11: Models

#11.1
rule model_X1:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata"
    output:
        vcem=config["model_dir"] + "/" + "VCEm_{bp}_{grm}_just_X1.csv",
        varabs=config["model_dir"] + "/" + "varabs_{bp}_{grm}_just_X1.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "model_just_X1.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.vcem}
        """

#11.2
rule model_X1_X2:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_{grm}.rds"
    output:
        vcem=config["model_dir"] + "/" + "VCEm_{bp}_{grm}_just_X1_X2.csv",
        varabs=config["model_dir"] + "/" + "varabs_{bp}_{grm}_just_X1_X2.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "model_just_X1_X2.R"
    resources: cpus=1, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -p {input.pcs} -o {params.INPUTDIR} -s {params.scratch} -r {output.vcem}
        """

###NEED JUST X1 X2 E MODEL
#11.3


#extra
rule model_X1_G:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_{grm}.rds"
    output:
        vcem=config["model_dir"] + "/" + "VCEm_{bp}_{grm}_G.csv",
        varabs=config["model_dir"] + "/" + "varabs_{bp}_{grm}_G.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "model_G.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -e {input.eigen} -o {params.INPUTDIR} -s {params.scratch} -r {output.vcem}
        """
#extra
rule model_X1X2_G_pcs_indiv:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_{grm}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_{grm}.rds"
    output:
        vcem=config["model_dir"] + "/" + "VCEm_{bp}_{grm}_G_pcs.csv",
        varabs=config["model_dir"] + "/" + "varabs_{bp}_{grm}_G_pcs.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "model_G_pcs.R"
    resources: cpus=5, mem_mb=50000, time_min=3000
    shell:
        """
       source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=5
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -e {input.eigen} -p {input.pcs} -o {params.INPUTDIR} -s {params.scratch} -r {output.varabs}
        """

#extra
rule model_X1_X2_G_pcs_indiv:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_{grm}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_{grm}.rds"
    output:
        vcem=config["model_dir"] + "/" + "VCEm_{bp}_{grm}_G_pcs_X_separated.csv",
        varabs=config["model_dir"] + "/" + "varabs_{bp}_{grm}_G_pcs_X_separated.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "higher_iter_model_G_pcs_X_separated.R"
    resources: cpus=5, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=5
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -e {input.eigen} -p {input.pcs} -o {params.INPUTDIR} -s {params.scratch} -r {output.varabs}
        """

##Need code for Emat creation

#extra
rule model_X1_G_E:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_{grm}.rds",
        envvar=config["sample_ids_dir"] + "/" + "Emat_20250106.RData"
    output:
        vcem=config["model_dir"] + "/" + "VCEm_{bp}_{grm}_G_E.csv",
        varabs=config["model_dir"] + "/" + "varabs_{bp}_{grm}_G_E.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "model_G_E.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -e {input.eigen} -v {input.envvar} -o {params.INPUTDIR} -s {params.scratch} -r {output.varabs}
        """

#11.5
rule model_X1_X2_G_E_pcs_plink:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_{grm}.rds",
 	      pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        envvar=config["model_dir"] + "/" + "E_eigen_G_E.rds"
    output:
         vcem=config["model_dir"] + "/" + "VCEm_{bp}_{grm}_run_G_E_pcrelate_pcs_plink.csv",
         varabs=config["model_dir"] + "/" + "varabs_{bp}_{grm}_run_G_E_pcrelate_pcs_plink.csv"
    params:
         INPUTDIR=config["model_dir"],
         scratch=config["scratch_dir"],
         SCRIPT=config["SCRIPT"] + "/" + "model_G_E_pcrelate_pcs_plink.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
         """
         ml R/4.1.2
         export OPENBLAS_NUM_THREADS=1
         export OMP_NUM_THREADS=1
         Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -e {input.eigen} -p {input.pcs} -v {input.envvar} -o {params.INPUTDIR} -s {params.scratch} -r {output.varabs}
         """
##NEED ADD G PCRELATE WITH PLINK PCS WITHOUT E

#extra
rule model_GE:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_{grm}.rds",
        envvar=config["model_dir"] + "/" + "E_eigen_G_E.rds",
        GE=config["model_dir"] + "/" + "eigen_GE_{grm}.rds"
    output:
        vcem=config["model_dir"] + "/" + "VCEm_{bp}_{grm}_GE.csv",
        varabs=config["model_dir"] + "/" + "varabs_{bp}_{grm}_GE.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "model_GE.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -e {input.eigen} -q {input.GE} -v {input.envvar} -o {params.INPUTDIR} -s {params.scratch} -r {output.varabs}
        """

#NEED ADD GE+PCS

#Predictions

#NEED add fold creation

#12.1
rule pred_model_X1:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}_X1.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_X1.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -f {input.folds}
        """

#12.2
rule pred_model_X1_X2:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}_X1_X2.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_X1_X2.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -f {input.folds} -p {input.pcs}
        """

#12.3
rule pred_model_X1_X2_G:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}_X1_X2_G.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_X1_X2_G.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -f {input.folds} -p {input.pcs} -e {input.eigen}
        """

#12.4
rule pred_model_X1_X2_E:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        envvar=config["model_dir"] + "/" + "E_eigen_G_E.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}_X1_X2_E.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_X1_X2_E.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -f {input.folds} -p {input.pcs} -v {input.envvar}
        """

#12.5
rule pred_model_X1_X2_G_E:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        envvar=config["model_dir"] + "/" + "E_eigen_G_E.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}_X1_X2_G_E.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_X1_X2_G_E.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -f {input.folds} -p {input.pcs} -v {input.envvar} -e {input.eigen}
        """

#12.6
rule pred_model_X1_X2_G_E_GE:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        envvar=config["model_dir"] + "/" + "E_eigen_G_E.rds",
        GE=config["model_dir"] + "/" + "eigen_GE_pcrelate.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}_X1_X2_G_E_GE.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_GE_folds.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -f {input.folds} -p {input.pcs} -v {input.envvar} -e {input.eigen} -q {input.GE}
        """

##Rule 13 Pred ethn based

#13.1
rule pred_model_ethn_X1:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}_X1.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_ethn_X1.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -a {input.ethn}
        """

#13.2
rule pred_model_ethn_X1_X2:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}_X1_X2.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_ethn_X1_X2.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -a {input.ethn} -p {input.pcs}
        """

#13.3
rule pred_model_ethn_X1_X2_G:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}_X1_X2_G.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_ethn_X1_X2_G.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -a {input.ethn} -p {input.pcs} -e {input.eigen}
        """

#13.4
rule pred_model_ethn_X1_X2_E:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        envvar=config["model_dir"] + "/" + "E_eigen_G_E.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}_X1_X2_E.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_ethn_X1_X2_E.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -a {input.ethn} -p {input.pcs} -v {input.envvar}
        """

#13.5
rule pred_model_ethn_X1_X2_G_E:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        envvar=config["model_dir"] + "/" + "E_eigen_G_E.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}_X1_X2_G_E.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_ethn_X1_X2_G_E.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -a {input.ethn} -p {input.pcs} -v {input.envvar} -e {input.eigen}
        """

#13.6
rule pred_model_ethn_X1_X2_G_E_GE:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        envvar=config["model_dir"] + "/" + "E_eigen_G_E.rds",
        GE=config["model_dir"] + "/" + "eigen_GE_pcrelate.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}_X1_X2_G_E_GE.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_ethn_X1_X2_G_E_GE.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -a {input.ethn} -p {input.pcs} -v {input.envvar} -e {input.eigen} -q {input.GE}
        """


#### Interaction GRM ####
#### Interaction GRM ####
#### Interaction GRM ####
#### Interaction GRM ####

rule create_plink_training_sets_fold_files:
    input:
        model_dir=config["model_dir"]
    output:
        train_keep=config["gwas_dir"] + "/Train_Set_{foldnum}.txt",
        test_keep=config["gwas_dir"] + "/Test_Set_{foldnum}.txt"
    params:
        script=config["SCRIPT"] + "/train_test_sets_folds_gwas_snpxenv_snakemake.R",
        output_dir=config["gwas_dir"]
    resources:
        cpus=1, mem_mb=10000, time_min=1000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1

        Rscript {params.script} -m {input.model_dir} -o {params.output_dir} -n {wildcards.foldnum}
        """

rule create_plink_training_sets_ancestry_files:
    input:
        ancestry_files=config["model_dir"] + "/{ancestry}_ids.txt"
    output:
        train_keep=config["gwas_dir"] + "/Train_exclude_{ancestry}.txt",
        test_keep=config["gwas_dir"] + "/Test_{ancestry}.txt"
    params:
        script=config["SCRIPT"] + "/train_test_sets_ethn_gwas_snpxenv_snakemake.R",
        output_dir=config["gwas_dir"]
    resources:
        cpus=1, mem_mb=10000, time_min=1000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1

        Rscript {params.script} -a {input.ancestry_files} -o {params.output_dir} -e {wildcards.ancestry}
        """

rule gwas_snp_env_folds:
    input:
        bfile=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv.bed",
        covar=config["gwas_dir"] + "/" + "covar_pheno.txt",
        train=config["gwas_dir"] + "/" + "Train_Set_{foldnum}.txt"
    output:
        done=config["gwas_dir"] + "/" + "gxe_{env}_{foldnum}.done"
    params:
        plink_executable_gwas = config["plink_executable_gwas"],
        COV=config["gwas_dir"] + "/" + "covar_pheno.txt",
        IPREFIX=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv",
        OPREFIX="gxe_{env}_{foldnum}",
        GWASDIR=config["gwas_dir"],
        TRAINSET=config["gwas_dir"] + "/" + "Train_Set_{foldnum}.txt"
    resources:
        cpus=1, mem_mb=10000, time_min=1440
    shell:
        """
        cd {params.GWASDIR}

        {params.plink_executable_gwas} \
        --bfile {params.IPREFIX} \
        --keep {params.TRAINSET} \
        --pheno {params.COV} --pheno-name DP0s, SP0s, PP0s \
        --covar {params.COV} --covar-name age,age2,sex,X1-X10,{wildcards.env} \
        --glm interaction \
        --parameters 1-15,29 \
        --out {params.OPREFIX}

        # Create a completion flag
        touch {output.done}
        """

rule gwas_snp_env_ancestry:
    input:
        bfile=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv.bed",
        covar=config["gwas_dir"] + "/" + "covar_pheno.txt",
        train=config["gwas_dir"] + "/" + "Train_exclude_{ancestry}.txt"
    output:
        done=config["gwas_dir"] + "/" + "gxe_{env}_{ancestry}.done"
    params:
        plink_executable_gwas = config["plink_executable_gwas"],
        COV=config["gwas_dir"] + "/" + "covar_pheno.txt",
        IPREFIX=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv",
        OPREFIX="gxe_{env}_{ancestry}",
        GWASDIR=config["gwas_dir"],
        TRAINSET=config["gwas_dir"] + "/" + "Train_exclude_{ancestry}.txt"
    resources:
        cpus=1, mem_mb=10000, time_min=1440
    shell:
        """
        cd {params.GWASDIR}

        {params.plink_executable_gwas} \
        --bfile {params.IPREFIX} \
        --keep {params.TRAINSET} \
        --pheno {params.COV} --pheno-name DP0s, SP0s, PP0s \
        --covar {params.COV} --covar-name age,age2,sex,X1-X10,{wildcards.env} \
        --glm interaction \
        --parameters 1-15,29 \
        --out {params.OPREFIX}

        # Create a completion flag
        touch {output.done}
        """

rule filter_snps:
    input:
        plink_results=config["gwas_dir"]
    output:
        summary=config["gwas_dir"] + "/summary_hits_{pval}.txt"
    params:
        script=config["SCRIPT"] + "/pvalue_filtering_gwas_snpxenv_snakemake.R",
        input_dir=config["gwas_dir"],
        output_dir=config["gwas_dir"]
    resources:
        cpus=10, mem_mb=100000, time_min=1000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1

        Rscript {params.script} -i {params.input_dir} -o {params.output_dir} -p {wildcards.pval}
        """

import os

def filter_existing_files(foldnum, bp, pval):
    """Filter only existing files for the specific foldnum bp and pval"""
    gwas_dir = config["gwas_dir"]
    env_list = config["ENV"]  # List of environments

    existing_files = []
    for env in env_list:
        file_path = f"{gwas_dir}/gxe_{env}_{foldnum}.{bp}0s_filtered_{pval}.txt"
        if os.path.exists(file_path):  # ✅ Check if file exists
            existing_files.append(file_path)

    return existing_files  # ✅ Return only valid files

rule hadamard_grm_folds:
    input:
        bfile=config["filtered_chr_dir"] + "/merged_geno_common_snps_selected_indiv.bed",
        filtered_snps=lambda wildcards: filter_existing_files(wildcards.foldnum, wildcards.bp, wildcards.pval),
        envmat=config["common_snps_dir"] + "/Emat_20250106.RData"
    output:
        grm=config["gwas_dir"] + "/Hadamard_GRM_Fold{foldnum}_{bp}_{pval}.RData"
    params:
        INPUTDIR=config["gwas_dir"],
        SCRIPT=config["SCRIPT"] + "/interaction_grm_folds_snakemake.R"
    resources:
        cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1

        Rscript {params.SCRIPT} \
        -d {params.INPUTDIR} \
        -b {input.bfile} \
        -e {input.envmat} \
        -s "{input.filtered_snps}" \
        -f {wildcards.foldnum} \
        -p {wildcards.bp} \
        -v {wildcards.pval} \
        -o {params.INPUTDIR}
        """

import os

def filter_existing_files(ancestry, bp, pval):
    """Filter only existing files for the specific ancestry, bp and pval"""
    gwas_dir = config["gwas_dir"]
    env_list = config["ENV"]  # List of environments

    existing_files = []
    for env in env_list:
        file_path = f"{gwas_dir}/gxe_{env}_{ancestry}.{bp}0s_filtered_{pval}.txt"
        if os.path.exists(file_path):  # ✅ Check if file exists
            existing_files.append(file_path)

    return existing_files  # ✅ Return only valid files

rule hadamard_grm_ancestry:
    input:
        bfile=config["filtered_chr_dir"] + "/merged_geno_common_snps_selected_indiv.bed",
        filtered_snps=lambda wildcards: filter_existing_files(wildcards.ancestry, wildcards.bp, wildcards.pval),
        envmat=config["common_snps_dir"] + "/Emat_20250106.RData"
    output:
        grm=config["gwas_dir"] + "/Hadamard_GRM_Ancestry{ancestry}_{bp}_{pval}.RData"
    params:
        INPUTDIR=config["gwas_dir"],
        SCRIPT=config["SCRIPT"] + "/interaction_grm_ethn_snakemake.R"
    resources:
        cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1

        Rscript {params.SCRIPT} \
        -d {params.INPUTDIR} \
        -b {input.bfile} \
        -e {input.envmat} \
        -s "{input.filtered_snps}" \
        -f {wildcards.ancestry} \
        -p {wildcards.bp} \
        -v {wildcards.pval} \
        -o {params.INPUTDIR}
        """

rule pred_model_fold_X1_X2_G_E_GE_GEselect:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        envvar=config["model_dir"] + "/" + "E_eigen_G_E.rds",
        GE=config["model_dir"] + "/" + "eigen_GE_pcrelate.rds",
        GEselect=config["gwas_dir"] + "/" + "Hadamard_GRM_Fold{foldnum}_{bp}_{pval}.RData"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}pval{pval}_X1_X2_G_E_GE_GEselect.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "predicting_folds_X1_X2_E_G_GE_GEselect_snakemake.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -f {input.folds} -p {input.pcs} -v {input.envvar} -e {input.eigen} -q {input.GE} -u {input.GEselect} -m {wildcards.pval}
        """

rule pred_model_ethn_X1_X2_G_E_GE_GEselect:
    input:
        data=config["sample_ids_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        envvar=config["model_dir"] + "/" + "E_eigen_G_E.rds",
        GE=config["model_dir"] + "/" + "eigen_GE_pcrelate.rds",
        GEselect=config["gwas_dir"] + "/" + "Hadamard_GRM_Ancestry{ancestry}_{bp}_{pval}.RData"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}pval{pval}_X1_X2_G_E_GE_GEselect.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "predicting_ethn_X1_X2_E_G_GE_GEselect_snakemake.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -r {output.preds} -a {input.ethn} -p {input.pcs} -v {input.envvar} -e {input.eigen} -q {input.GE} -u {input.GEselect} -m {wildcards.pval}
        """


#### Sex and Age added to the Environment Variable Matrix. ####
#### Sex and Age added to the Environment Variable Matrix. ####
#### Sex and Age added to the Environment Variable Matrix. ####
#### Sex and Age added to the Environment Variable Matrix. ####

## E matrix creating and eigen of E matrix ##
## E matrix creating and eigen of E matrix ##
## E matrix creating and eigen of E matrix ##

rule creating_Emat:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata"
    output:
        emat=config["data_dir"] + "/" + "Emat_with_sex_age.RDS",
        eigen_emat=config["data_dir"] + "/" + "Emat_eigen_with_sex_age.RDS"
    params:
        OUTDIR=config["data_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "Emat_creating_with_sex_age.R"
    resources: cpus=10, mem_mb=100000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1
        Rscript {params.SCRIPT} -i {input.data} -d {params.OUTDIR}
        """

## GE matrix creating and eigen of GE matrix ##
## GE matrix creating and eigen of GE matrix ##
## GE matrix creating and eigen of GE matrix ##

rule creating_GE_S_A:
    input:
        emat=config["data_dir"] + "/" + "Emat_with_sex_age.RDS",
        grm=config["filtered_chr_dir"] + "/" + "grm_matrix_{grm}_5pcs.RData"
    output:
        gemat=config["data_dir"] + "/" + "GE_S_A_hadamard_prod_{grm}.RDS",
        ge_eigen=config["data_dir"] + "/" + "GE_S_A_eigen_{grm}.RDS"
    params:
        OUTDIR=config["data_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "GE_S_A_hadamard_prod_eigen_creation_snakemake.R"
    resources: cpus=10, mem_mb=100000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1
        Rscript {params.SCRIPT} -d {params.OUTDIR} -g {input.grm} -e {input.emat}
        """

## Variance Components Estimation BGLR Models ##
## Variance Components Estimation BGLR Models ##
## Variance Components Estimation BGLR Models ##

rule model_X2:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds"
    output:
        done=config["model_dir"] + "/" + "done_{bp}_{grm}_S_A_X2.done"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "model_S_A_X2.R"

    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -p {input.pcs} -o {params.INPUTDIR} -s {params.scratch} -b {wildcards.bp} -g {wildcards.grm}

        # Create a completion flag
        touch {output.done}
        """

rule model_X2_E:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        emat=config["data_dir"] + "/" + "Emat_eigen_with_sex_age.RDS"
    output:
        done=config["model_dir"] + "/" + "done_{bp}_{grm}_S_A_X2_E.done"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "model_S_A_X2_E.R"

    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -p {input.pcs} -o {params.INPUTDIR} -s {params.scratch} -b {wildcards.bp} -g {wildcards.grm} -e {input.emat}

        # Create a completion flag
        touch {output.done}
        """

rule model_X2_G:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        gen_eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds"
    output:
        done=config["model_dir"] + "/" + "done_{bp}_{grm}_S_A_X2_G.done"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "model_S_A_X2_G.R"

    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -p {input.pcs} -o {params.INPUTDIR} -s {params.scratch} -b {wildcards.bp} -g {wildcards.grm} -w {input.gen_eigen}

        # Create a completion flag
        touch {output.done}
        """

rule model_X2_G_E:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        gen_eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        emat=config["data_dir"] + "/" + "Emat_eigen_with_sex_age.RDS"
    output:
        done=config["model_dir"] + "/" + "done_{bp}_{grm}_S_A_X2_G_E.done"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "model_S_A_X2_G_E.R"

    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -p {input.pcs} -o {params.INPUTDIR} -s {params.scratch} -b {wildcards.bp} -g {wildcards.grm} -w {input.gen_eigen} -e {input.emat}

        # Create a completion flag
        touch {output.done}
        """

rule model_X2_G_E_GE:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        gen_eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        emat=config["data_dir"] + "/" + "Emat_eigen_with_sex_age.RDS",
        gemat=config["data_dir"] + "/" + "GE_S_A_eigen_{grm}.RDS"
    output:
        done=config["model_dir"] + "/" + "done_{bp}_{grm}_S_A_X2_G_E_GE.done"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "model_S_A_X2_G_E_GE.R"

    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -p {input.pcs} -o {params.INPUTDIR} -s {params.scratch} -b {wildcards.bp} -g {wildcards.grm} -w {input.gen_eigen} -e {input.emat} -x {input.gemat}

        # Create a completion flag
        touch {output.done}
        """

## Predictions for Random cross validation with BGLR Models ##
## Predictions for Random cross validation with BGLR Models ##
## Predictions for Random cross validation with BGLR Models ##

rule pred_model_rnd_S_A_X2:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}_S_A_X2.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_rnd_S_A_X2.R"
    resources: cpus=1, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=1
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -p {input.pcs} -o {params.INPUTDIR} -s {params.scratch} -f {input.folds} -b {wildcards.bp} -n {wildcards.foldnum}
        """

rule pred_model_rnd_S_A_X2_E:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        emat=config["data_dir"] + "/" + "Emat_eigen_with_sex_age.RDS"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}_S_A_X2_E.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_rnd_S_A_X2_E.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -f {input.folds} -p {input.pcs} -e {input.emat} -b {wildcards.bp} -n {wildcards.foldnum}
        """

rule pred_model_rnd_S_A_X2_G:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        gen_eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}_S_A_X2_G.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_rnd_S_A_X2_G.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -f {input.folds} -p {input.pcs} -w {input.gen_eigen} -b {wildcards.bp} -n {wildcards.foldnum}
        """

rule pred_model_rnd_S_A_X2_G_E:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        gen_eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        emat=config["data_dir"] + "/" + "Emat_eigen_with_sex_age.RDS"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}_S_A_X2_G_E.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_rnd_S_A_X2_G_E.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -f {input.folds} -p {input.pcs} -e {input.emat} -w {input.gen_eigen} -b {wildcards.bp} -n {wildcards.foldnum}
        """

rule pred_model_rnd_S_A_X2_G_E_GE:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        folds=config["model_dir"] + "/" + "Fold_{foldnum}.rds",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        gen_eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        emat=config["data_dir"] + "/" + "Emat_eigen_with_sex_age.RDS",
        gemat=config["data_dir"] + "/" + "GE_S_A_eigen_pcrelate.RDS"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_Fold_{foldnum}_S_A_X2_G_E_GE.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_rnd_S_A_X2_G_E_GE.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -f {input.folds} -p {input.pcs} -e {input.emat} -w {input.gen_eigen} -b {wildcards.bp} -n {wildcards.foldnum} -x {input.gemat}
        """

## Predictions for Across ethnicity cross validation with BGLR Models ##
## Predictions for Across ethnicity cross validation with BGLR Models ##
## Predictions for Across ethnicity cross validation with BGLR Models ##


rule pred_model_ethn_S_A_X2:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}_S_A_X2.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_ethn_S_A_X2.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -a {input.ethn} -p {input.pcs} -b {wildcards.bp} -n {wildcards.ancestry}
        """

rule pred_model_ethn_S_A_X2_E:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        emat=config["data_dir"] + "/" + "Emat_eigen_with_sex_age.RDS"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}_S_A_X2_E.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_ethn_S_A_X2_E.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -a {input.ethn} -p {input.pcs} -e {input.emat} -b {wildcards.bp} -n {wildcards.ancestry}
        """

rule pred_model_ethn_S_A_X2_G:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        gen_eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}_S_A_X2_G.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_ethn_S_A_X2_G.R"
    resources: cpus=10, mem_mb=50000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.0.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -a {input.ethn} -p {input.pcs} -w {input.gen_eigen} -b {wildcards.bp} -n {wildcards.ancestry}
        """

rule pred_model_ethn_S_A_X2_G_E:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        emat=config["data_dir"] + "/" + "Emat_eigen_with_sex_age.RDS"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}_S_A_X2_G_E.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_ethn_S_A_X2_G_E.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -a {input.ethn} -p {input.pcs} -e {input.emat} -w {input.eigen} -b {wildcards.bp} -n {wildcards.ancestry}
        """

rule pred_model_ethn_S_A_X2_G_E_GE:
    input:
        data=config["data_dir"] + "/" + "scaled_dataset_20250106.Rdata",
        ethn=config["model_dir"] + "/" + "{ancestry}_ids.txt",
        pcs=config["filtered_chr_dir"] + "/" + "scaled_pcs_plink.rds",
        eigen=config["filtered_chr_dir"] + "/" + "pca_for_pcrelate.rds",
        emat=config["data_dir"] + "/" + "Emat_eigen_with_sex_age.RDS",
        gemat=config["data_dir"] + "/" + "GE_S_A_eigen_pcrelate.RDS"
    output:
        preds=config["model_dir"] + "/" + "PREDs_{bp}_ethn_{ancestry}_S_A_X2_G_E_GE.csv"
    params:
        INPUTDIR=config["model_dir"],
        scratch=config["scratch_dir"],
        SCRIPT=config["SCRIPT"] + "/" + "pred_model_ethn_S_A_X2_G_E_GE.R"
    resources: cpus=10, mem_mb=150000, time_min=3000
    shell:
        """
        source /opt/intel/oneapi/mkl/2023.2.0/env/vars.sh intel64
        module load R/4.2.3
        export MKL_NUM_THREADS=10
        Rscript {params.SCRIPT} -d {params.INPUTDIR} -t {input.data} -o {params.INPUTDIR} -s {params.scratch} -a {input.ethn} -p {input.pcs} -e {input.emat} -w {input.eigen} -b {wildcards.bp} -n {wildcards.ancestry} -x {input.gemat}
        """

#### Sex and Age Interaction GRM GWAS ####
#### Sex and Age Interaction GRM GWAS ####
#### Sex and Age Interaction GRM GWAS ####
#### Sex and Age Interaction GRM GWAS ####

rule gwas_snp_env_folds_S_A:
    input:
        bfile=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv.bed",
        covar=config["gwas_dir"] + "/" + "covar_pheno_sex_age2_scaled.txt",
        train=config["gwas_dir"] + "/" + "Train_Set_{foldnum}.txt"
    output:
        done=config["gwas_dir"] + "/" + "gxe_{env}_{foldnum}_S_A.done"
    params:
        plink_executable_gwas = config["plink_executable_gwas"],
        COV=config["gwas_dir"] + "/" + "covar_pheno.txt",
        IPREFIX=config["filtered_chr_dir"] + "/" + "merged_geno_common_snps_selected_indiv",
        OPREFIX="gxe_{env}_{foldnum}_S_A",
        GWASDIR=config["gwas_dir"],
        TRAINSET=config["gwas_dir"] + "/" + "Train_Set_{foldnum}.txt"
    resources:
        cpus=1, mem_mb=10000, time_min=1440
    shell:
        """
        cd {params.GWASDIR}

        {params.plink_executable_gwas} \
        --bfile {params.IPREFIX} \
        --keep {params.TRAINSET} \
        --pheno {params.COV} --pheno-name DP0s, SP0s, PP0s \
        --covar {params.COV} --covar-name X1-X10,{wildcards.env} \
        --glm interaction \
        --out {params.OPREFIX}

        # Create a completion flag
        touch {output.done}
        """

